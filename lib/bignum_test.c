#define DESIRED_PRECISION 1234
#include <assert.h>
#include <stdlib.h>
#include <time.h>
#include "bignum.h"

long lrand() {
    long x =  ((long) rand() << 32) + rand();
    long y =  ((long) rand() << 32) + rand();
    return x - y;
}

void test_string_conversion() {
    char* x; char* y; bignum* b;

    x = "4851750042040455152019681573632102702181650623656232546615444294887" \
        "5201180572745688820474429165821644056242325808032976176137617648427" \
        "2068350283114280551697667863925904420959975342619687017230984915451" \
        "5869976160699775236059753844798389250636280713209253752950445588169";
    b = bignum_from_string(x);
    y = bignum_to_string(b);
    assert(strcmp(x, y) == 0);
    free(y);

    x = "-826166070545658643178360396426180936495174719253069245631153377947" \
        "5164460646762757044254155112259745889423838439287112459368850913673" \
        "5469712889996795094784243872036349166797625205597317314934185161533" \
        "0272846621782453544664265968113472032262492253141733676261430019884";
    b = bignum_from_string(x);
    y = bignum_to_string(b);
    assert(strcmp(x, y) == 0);
    free(y);

    x = "     +3132130123123  - +  321 0512 3921 31 5012312 321 69 1 113";
    b = bignum_from_string(x);
    y = bignum_to_string(b);
    assert(strcmp("3132130123123", y) == 0);
    free(y);

    x = "    # 2130  21 52193 15 2193";
    b = bignum_from_string(x);
    y = bignum_to_string(b);
    assert(strcmp("0", y) == 0);
    free(y);
}

void test_long_conversion() {
    for (long i = -10000; i < 10000; i++) {
        long x = i * lrand();
        bignum* b = bignum_from_long(x);
        assert(bignum_to_long(b) == x);
        bignum_free(b);
    }
}

void test_string_long_conversion() {
    char buffer[64];
    for (long i = -10000; i < 10000; i++) {
        long x = i * lrand();
        sprintf(buffer, "%li", x);

        bignum* a = bignum_from_long(x);
        char* s = bignum_to_string(a);
        assert(strcmp(s, buffer) == 0);
        free(s);
        bignum_free(a);

        bignum* b = bignum_from_string(buffer);
        assert(x == bignum_to_long(b));
        bignum_free(b);
    }
}

void test_bignum_compare() {
    #define COMPARE(x, y) ((x) == (y) ? 0 : ((x) < (y) ? -1 : 1))

    for (int i = 0; i < 1000000; i++) {
        long x = lrand() * lrand();
        long y = lrand() * lrand();
        bignum* a = bignum_from_long(x);
        bignum* b = bignum_from_long(y);

        assert(COMPARE(x, x) == bignum_compare(a, a));
        assert(COMPARE(x, y) == bignum_compare(a, b));
        assert(COMPARE(y, x) == bignum_compare(b, a));
        assert(COMPARE(y, y) == bignum_compare(b, b));

        bignum_free(a);
        bignum_free(b);
    }

    bignum *a, *b; char *x, *y;

    x = "8676765595918383249500680125447918377114938231062194996446452894345" \
        "5455741698050039328792343391888783657123773862519297704030910289708" \
        "6813368769108447779345008886322394478152757700101226503240193717480" \
        "1840233276670368821169092413853151965353784455661302878707968570046";

    y = "3541568026317610614163085421530087163267609108318884667861064057208" \
        "2916149435168214424091187700983591102880945186711746852803705071025" \
        "0502850186297164103933438294965696648056595683879367056313327303339" \
        "7005831173681401054228485897588275535995620999137186948094348978997";

    a = bignum_from_string(x);
    b = bignum_from_string(y);
    assert(bignum_compare(a, b) == 1);
    assert(bignum_compare(b, a) == -1);
    bignum_free(a);
    bignum_free(b);

    x = "-497684146341326209520445946226492225207488614437747134395686122576" \
        "9544286043640891716349399705344343505747080860377038086857873405332" \
        "5387501625328293346487016481612619237467996969578522148365217735891" \
        "5632615653292683568463599452246810108948740209845964871067386788669";

    y = "-621720223245350910091576176515565335129489169791148542700365354701" \
        "9026622502065920789087966551153891099295945775296030181437167349362" \
        "8746057376268192836900087481853340153352197338675484368389177811323" \
        "2458479625384502632297260864684631354847493289713842509941511941651";

    a = bignum_from_string(x);
    b = bignum_from_string(y);
    assert(bignum_compare(a, b) == 1);
    assert(bignum_compare(b, a) == -1);
    bignum_free(a);
    bignum_free(b);
}

void test_bignum_add_sub() {
    for (long i = -10000; i < 10000; i++) {
        // shifting to prevent overflows during addition
        long x = (i * lrand()) >> 4;
        long y = (i * lrand()) >> 4;

        bignum* a = bignum_from_long(x);
        bignum* b = bignum_from_long(y);

        bignum* c = bignum_add(a, b);
        bignum* d = bignum_add(b, a);
        assert(bignum_compare(c, d) == 0);
        assert(bignum_to_long(c) == x + y);

        bignum* e = bignum_sub(a, b);
        bignum* f = bignum_sub(b, a);
        assert(bignum_to_long(e) == x - y);
        assert(bignum_to_long(f) == y - x);
        f->sign = e->sign;
        assert(bignum_compare(e, f) == 0);

        bignum_free(a);
        bignum_free(b);
        bignum_free(c);
        bignum_free(d);
        bignum_free(e);
        bignum_free(f);
    }

    bignum *a, *b, *c; char *w, *x, *y, *z;

    w = "6371461303592560996247352735370414493939868576070416282699583989237" \
        "6194570433269570540169574908456547666966889541515817235895429454237" \
        "6354664764684378940104365200077413189425003519725764965802893398228" \
        "41792703255820656951997404514844204557017491455320613539190817223";

    x = "-526278375496736463103086409672773803465831383654129236622813873506" \
        "9256549649349700496037254255083576909426303592977913748868994672865" \
        "2769655440361957545019809636367862081701434627433631962917907896599" \
        "5887863724302343431128818678037125058562960299020705170356128465257";

    y = "-462563762460810853140612882319069658526432697893425073795818033614" \
        "5494603945017004790635558505999011432756634697562755576510040378322" \
        "9006108792715113755618765984367087949807184592236374313259878962617" \
        "3046071021046522774176821273522280854005942807565384556816937648034";

    a = bignum_from_string(w);
    b = bignum_from_string(x);
    c = bignum_add(a, b);
    z = bignum_to_string(c);
    assert(strcmp(y, z) == 0);
    bignum_free(a);
    bignum_free(b);
    bignum_free(c);
    free(z);


    w = "1739819415563723659413828171665816301338750354659982042805102626650" \
        "7925593512034568829657485795754040493808579908070007920574587999347" \
        "4175148555824128249667444349971178168495359785898178219914665618667" \
        "4891053831767915011393142527153663913625386565836996534063593130056";

    x = "-116499521377429617640796023287488879197436694789240507296066230563" \
        "7725944069258309470392167572962310332170200018244856740771375455209" \
        "2902702727635960139906568572227173431062058408116893646887819609408" \
        "5312006394145170879868330600965838224697936376701939100985238424795";

    y = "1856318936941153277054624194953305180536187049449222550101168857214" \
        "5651537581292878300049653368716350825978779926314864661345963454556" \
        "7077851283460088389574012922198351599557418194015071866802485228076" \
        "0203060225913085891261473128119502138323322942538935635048831554851";

    a = bignum_from_string(w);
    b = bignum_from_string(x);
    c = bignum_sub(a, b);
    z = bignum_to_string(c);
    assert(strcmp(y, z) == 0);
    bignum_free(a);
    bignum_free(b);
    bignum_free(c);
    free(z);
}

void test_bignum_mult() {
    for (long i = -10000; i < 10000; i++) {
        // shifting to prevent overflows during multiplication
        long x = (i * lrand()) >> 32;
        long y = (i * lrand()) >> 32;

        bignum* a = bignum_from_long(x);
        bignum* b = bignum_from_long(y);
        bignum* c = bignum_mult(a, b);
        bignum* d = bignum_mult(b, a);
        assert(bignum_compare(c, d) == 0);
        assert(bignum_to_long(c) == x * y);

        bignum_free(a);
        bignum_free(b);
        bignum_free(c);
        bignum_free(d);
    }

    bignum *a, *b, *c, *d; char *w, *x, *y, *z;

    w = "1254993619271765774904345853005449655659994074038390889394680667432" \
        "9228765190159949561237141347032586126398727815651190493708909018167" \
        "0433840076962051571621586101875373067660861570761697102739527426693" \
        "8928583692931536301908138829068491141765965848821470183921617845688";

    x = "2984840977890857072604181151920197115147759952631943357895527897768" \
        "0568921226109486975814805485076534954859370134294091945920851541986" \
        "8090961985770513569519313185862599264443611024822955494944382795821" \
        "2596581811367405071653727396588124388285952036834112910420962405672";

    y = "3745956381793923325882021278475894098875107229182246651026117746543" \
        "8954098928585942197876268186662915253485701108176624029197968987235" \
        "3824003954069964942265989108890525802100197159253618884805046855184" \
        "4403596780924166739894573219684863457373548842211708880087335214914" \
        "3268851528783297408524974276566314693958851346785480657524705273573" \
        "2623111738743961368870035465993065569024904339579975321920435714238" \
        "2784149770775525966866664867348436825486327300193627553619977680422" \
        "366440771917570381320150532934070055994848610213175487066551942336";

    a = bignum_from_string(w);
    b = bignum_from_string(x);
    c = bignum_mult(a, b);
    d = bignum_mult(b, a);
    z = bignum_to_string(c);
    assert(bignum_compare(c, d) == 0);
    assert(strcmp(y, z) == 0);
    bignum_free(a);
    bignum_free(b);
    bignum_free(c);
    bignum_free(d);
    free(z);


    w = "-744095392547855109937689947630686292443070731294572393659305537536" \
        "3533939018442481681407824936269886079064296039249229077101691237384" \
        "7379212075074175049492021933603616959001028747974372314151405523993" \
        "4001657181482643057489454565961008016780874306400297225066117295637" \
        "6446315670501566575846062930358006814280067224920768653152753000579" \
        "8164064101988975771240133809558330732816032285422697956166520354361" \
        "9617496792706092170689284446586828091017879645378151739569270693972" \
        "68510849697475758487653884297832784064381376";

    x = "9738922852359991069261735828832888310946595905578782138101256009011" \
        "1917229493674092334145115257102113286943356094696466955184803818753" \
        "4495700287570253243929046863181803430587440249150331706043488603691" \
        "0010408307726524475610140802761688285132005094072300330774115739552" \
        "5467981470294673994724201802709018719091934078579506904982495034896" \
        "8675827661250664602489939812251376446833928180620509372515382853744" \
        "2603694089005935990137103829988761356798737475927155289328602974687" \
        "3874040494621010850961925386150054350292125";

    y = "-724668762282008432975317434605400175906100082511438766897572663002" \
        "9108631693403626486758075172456166641825951506179396874628374774741" \
        "0584563112205731116632944094552878629312628745132003011634834349759" \
        "3701311226148929614389039934968266858008695810145826297437028408748" \
        "8554923722445454641893128590308778325005176321302953589386327431766" \
        "3325803800586347498087242165656381564061608314687369373651628745778" \
        "4196726012473001570574536980233424228132610635976237387398848854155" \
        "2898004736362550870593625870821771172391024473198295865571276200189" \
        "2809897336849589457639329946548281288959143439759098326501032997652" \
        "7407528451022796079023490083345139003067603146218085985287644556168" \
        "0888225008990852327644713212650578401459179983861582722612094688407" \
        "1946232004816530831848627209161631703346788789267204766088782476747" \
        "8188882949766485661325251314380660366280678592568332572140165898004" \
        "4495939503290836347982960949409735133627434843162092921595273780052" \
        "4498805773364627325353875668219210464273086565092168093900066997319" \
        "86643572593009464000";

    a = bignum_from_string(w);
    b = bignum_from_string(x);
    c = bignum_mult(a, b);
    d = bignum_mult(b, a);
    z = bignum_to_string(c);
    assert(bignum_compare(c, d) == 0);
    assert(strcmp(y, z) == 0);
    bignum_free(a);
    bignum_free(b);
    bignum_free(c);
    bignum_free(d);
    free(z);
}

void test_bignum_div_mod() {
    for (long i = 0; i < 1000000; i++) {
        long x = lrand();
        long y = lrand() | 1;

        bignum* a = bignum_from_long(x);
        bignum* b = bignum_from_long(y);
        bignum* c = bignum_div(a, b);
        bignum* d = bignum_mod(a, b);

        assert(bignum_to_long(c) == x / y);
        assert(bignum_to_long(d) == x % y);

        bignum_free(a);
        bignum_free(b);
        bignum_free(c);
        bignum_free(d);
    }

    bignum *a, *b, *c, *d; char *w, *x, *q, *r, *zq, *zr;

    w = "-194017417098542292958327741912724614426492544450395637783409087843" \
        "1601988176889445656558721554962810531538887877034819978568371675152" \
        "6094432925881765112479573619230888417750681516853057823172013921272" \
        "5562338763366095496100527395156336505973820776112367376559843268622" \
        "4783984581230975050779357519666358793883151849264613751076654603462" \
        "7875319713997645103753762171977461500413067594595214277067661034343" \
        "8442386839262451699277809303118841766191351288235272736131186662260" \
        "899401707910420534217540469421249";

    x = "8846146718977194155979187558405814412325105457914847586490484972673" \
        "5195135750902278135711390556795796426703725438981940241454035970265" \
        "0684067344949444067422432966108366022102893377194706624101917740130" \
        "18427827005455105887191543208989761505475806539546";

    q = "-219324213425407556072058026858230966414475965179769407147028857588" \
        "7950637536336167646208748909365734984644760699416901722471691415249" \
        "5670989955118406000308719000100887116299247213565425828137526334604" \
        "79920405723433930081513046167497011861626308928670";

    r = "-271203112825529819668518381819582780058691338961231697054398801533" \
        "8744069474737775137494994472480789820332128809424243944149627884293" \
        "3680057740793332499242331488727428933824533789483302852175581971050" \
        "823089583804366123236708747539334246724305221237429";

    a = bignum_from_string(w);
    b = bignum_from_string(x);
    c = bignum_div(a, b);
    d = bignum_mod(a, b);
    zq = bignum_to_string(c);
    zr = bignum_to_string(d);

    assert(strcmp(zq, q) == 0);
    assert(strcmp(zr, r) == 0);
    bignum_free(a);
    bignum_free(b);
    bignum_free(c);
    bignum_free(d);
    free(zq);
    free(zr);
}

void test_bignum_mod_exp() {
    #define ABS(x) ({__typeof__(x) _x = (x); _x < 0 ? -_x : _x;})

    for (int i = 0; i < 10000; i++) {
        long base = lrand() % 1000000;
        long exp = ABS(lrand() % 100);
        long mod = 1 + ABS(lrand() % 1000000);

        long res1 = 1;
        long res2 = 1;
        for (int i = 0; i < exp; i++) {
            res1 *= base;
            res2 = (res2 * base) % mod;
        }

        bignum* a = bignum_from_long(base);
        bignum* b = bignum_from_long(exp);
        bignum* c = bignum_from_long(mod);
        bignum* d = bignum_mod_exp(a, b, NULL);
        bignum* e = bignum_mod_exp(a, b, c);

        assert(bignum_to_long(d) == res1);
        assert(bignum_to_long(e) == res2);

        bignum_free(a);
        bignum_free(b);
        bignum_free(c);
        bignum_free(d);
        bignum_free(e);
    }

    bignum *a, *b, *c, *d; char *w, *x, *y, *r, *z;

    w = "5033125625801845998719923257749709268586450520229822553593266686808" \
        "7463476259032478632520279408673361393697713145762683542428679210367" \
        "1870869444860208656679761358340687509307221181095418410081780325670" \
        "0794658657666004626546573271124404872036491320355461401325191377021";

    x = "8012571871271541771559070512664105664003885239017486219934668760829" \
        "1757244443401530786057300690133864664805483085975042707101710404418" \
        "5482214979121933712820530548052958144661438810939833475428431872819" \
        "6485856500466036257371990364877323687783873064739917122425537232199";

    y = "1467798781524686010519171756918170102858780155885280868304186210706" \
        "5062816257860325321464790977990565147068722038722979769419327888076" \
        "7721321542232619021097499887082687809315002614236037785894637707847" \
        "0253569202577049622106079506540037100560725592771805320143894950081";

    r = "5579934207458089261345983490659260103996030707462500862425609059582" \
        "8151021558366575971043283458603051534112863764267710830245687470151" \
        "6278500368974597340700585379348265884292448919545585047955966298687" \
        "894496320263574058863684107414416276886790335415993311279784644405";

    a = bignum_from_string(w);
    b = bignum_from_string(x);
    c = bignum_from_string(y);
    d = bignum_mod_exp(a, b, c);
    z = bignum_to_string(d);
    assert(strcmp(z, r) == 0);

    bignum_free(a);
    bignum_free(b);
    bignum_free(c);
    bignum_free(d);
    free(z);
}

int main(void) {
    // srand(time(NULL));
    start_time();
    test_string_conversion();
    test_long_conversion();
    test_string_long_conversion();
    test_bignum_compare();
    test_bignum_add_sub();
    test_bignum_mult();
    test_bignum_div_mod();
    test_bignum_mod_exp();
    printf("All tested passed in ");
    end_time();
}
